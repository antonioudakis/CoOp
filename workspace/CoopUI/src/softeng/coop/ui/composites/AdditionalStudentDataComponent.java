package softeng.coop.ui.composites;

import java.util.Locale;
import java.util.Vector;

import softeng.coop.dataaccess.IdentificationType;
import softeng.coop.dataaccess.Location;
import softeng.coop.dataaccess.Nationality;
import softeng.coop.dataaccess.Person;
import softeng.coop.dataaccess.Student;
import softeng.coop.ui.EnumComboBox;
import softeng.coop.ui.ICoopContext;
import softeng.coop.ui.composites.PickerField.ParentAdjuster;
import softeng.coop.ui.data.DataUtilities;
import softeng.coop.ui.data.MultilingualValidationForm;
import softeng.coop.ui.data.NotNullMultilingualValidator;
import softeng.coop.ui.viewdefinitions.IAdditionalStudentDataView;
import softeng.ui.vaadin.mvp.IView;
import softeng.ui.vaadin.mvp.Presenter;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Item;
import com.vaadin.data.util.BeanItem;
import com.vaadin.ui.CheckBox;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.Component;
import com.vaadin.ui.DateField;
import com.vaadin.ui.Field;
import com.vaadin.ui.FormFieldFactory;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;

public class AdditionalStudentDataComponent 
	extends CoopComponent<BeanItem<Student>>
	implements IAdditionalStudentDataView
{
	@AutoGenerated
	private VerticalLayout mainLayout;

	@AutoGenerated
	private AdditionalDataForm form;

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	private boolean fullyWritableForm = false;
	
	public static class AdditionalDataForm extends MultilingualValidationForm<Person>//BeanValidationForm<Person>
	{
		private static final long serialVersionUID = 1L;

		public AdditionalDataForm()
		{
			super(Person.class);
		}
	}
	
	private static final long serialVersionUID = 1L;
	
	private TextField serialNumberTextField;
	private TextField idNumberTextField;
	private TextField taxCodeTextField;
	private DateField admissionDateField;
	private LocationPickerField idIssuerLocationField;
	private TextField socialSecurityIdField;
	private TextField amaField;
	private TextField ibanTextField;
	private CheckBox immigrantCheckBox;
	private CheckBox hasSpecialNeedsCheckBox;
	private TextField workExperienceTextField;
	private ComboBox idTypeComboBox;
	private DateField idIssueDateField;
	private TextField idIssuerTextField;
	private CheckBox hasOtherDegreeCheckBox;
	private CheckBox religiousMinorityCheckBox;
	private CheckBox ethnicMinorityCheckBox;
	private NationalityPickerField nationalityPickerField;
	private CheckBox publicClerkCheckBox;
	private TextField taxDivisionTextField;
	
	private static Vector<String> propertyIds = createPropertyIds();

	private static NotNullMultilingualValidator notNullValidator = 
		new NotNullMultilingualValidator();

	/**
	 * The constructor should first build the main layout, set the
	 * composition root and then do any custom initialization.
	 *
	 * The constructor will not be automatically regenerated by the
	 * visual editor.
	 */
	public AdditionalStudentDataComponent()
	{
		buildMainLayout();
		setCompositionRoot(mainLayout);
	}

	private static Vector<String> createPropertyIds()
	{
		Vector<String> list = new Vector<String>();
		
		list.add("serialNumber");
		list.add("admissionDate");
		list.add("idType");
		list.add("idNumber");
		list.add("idIssuer");
		list.add("issuerLocation");
		list.add("idIssueDate");
		list.add("taxId");
		list.add("taxDivision");
		list.add("socialSecurityId");
		list.add("ama");
		list.add("addresses");
		list.add("iban");
		list.add("immigrant");
		list.add("nationality");
		list.add("hasSpecialNeeds");
		list.add("hasOtherDegree");
		list.add("religiousMinority");
		list.add("ethnicMinority");
		list.add("publicClerk");
		list.add("workExperience");
		
		return list;
	}

	@Override
	protected Presenter<BeanItem<Student>, ICoopContext, ? extends IView<BeanItem<Student>, ICoopContext>> supplyPresenter()
	{
		return null;
	}

	@Override
	public void dataBind()
	{
		this.form.setItemDataSource(this.getModel(), propertyIds);
	}

	@SuppressWarnings("serial")
	@Override
	protected void setupUI()
	{
		super.setupUI();
		
		this.form.setImmediate(true);
		this.form.setWriteThrough(false);
		this.form.setFormFieldFactory(new FormFieldFactory()
		{
			@Override
			public Field createField(Item item, Object propertyId, Component uiContext)
			{
				if (propertyId.equals("serialNumber"))
				{
					serialNumberTextField = new TextField();
					
					serialNumberTextField.setCaption(getLocalizedString("SERIAL_NUMBER_CAPTION"));
					serialNumberTextField.setDescription(getLocalizedString("SERIAL_NUMBER_DESCRIPTION"));
					serialNumberTextField.setWidth("100%");
					serialNumberTextField.setNullRepresentation("");
					serialNumberTextField.setNullSettingAllowed(true);
					
					if (fullyWritableForm)
						serialNumberTextField.setReadOnly(false);
					else
						serialNumberTextField.setReadOnly(true);
					
					return serialNumberTextField;
				}
				else if (propertyId.equals("idNumber"))
				{
					idNumberTextField = new TextField();
					
					idNumberTextField.setCaption(getLocalizedString("ID_NUMBER_CAPTION"));
					idNumberTextField.setWidth("100%");
					idNumberTextField.setNullRepresentation("");
					idNumberTextField.setNullSettingAllowed(true);

					idNumberTextField.addValidator(notNullValidator);
					
					return idNumberTextField;
				}
				else if (propertyId.equals("taxId"))
				{
					taxCodeTextField = new TextField();
					
					taxCodeTextField.setCaption(getLocalizedString("TAX_CODE_CAPTION"));
					taxCodeTextField.setWidth("100%");
					taxCodeTextField.setNullRepresentation("");
					taxCodeTextField.setNullSettingAllowed(true);
					
					if (isUserStudent())
						taxCodeTextField.addValidator(notNullValidator);

					return taxCodeTextField;
				}
				else if (propertyId.equals("taxDivision"))
				{
					taxDivisionTextField = new TextField();
					taxDivisionTextField.setWidth("100%");
					taxDivisionTextField.setCaption(getLocalizedString("TAX_DIVISION_CAPTION"));
					taxDivisionTextField.setNullRepresentation("");
					taxDivisionTextField.setNullSettingAllowed(true);
					
					if (isUserStudent())
						taxDivisionTextField.addValidator(notNullValidator);

					return taxDivisionTextField;
				}
				else if (propertyId.equals("admissionDate"))
				{
					admissionDateField = new DateField();
					
					admissionDateField.setCaption(getLocalizedString("ADMISSION_DATE_CAPTION"));
					admissionDateField.setWidth("100%");
					admissionDateField.setResolution(DateField.RESOLUTION_DAY);
					
					return admissionDateField;
				}
				else if (propertyId.equals("issuerLocation"))
				{
					idIssuerLocationField = new LocationPickerField();
					
					idIssuerLocationField.setCaption(getLocalizedString("ID_ISSUER_LOCATION_CAPTION"));
					idIssuerLocationField.setDescription(getLocalizedString("ID_ISSUER_LOCATION_DESCRIPTION"));
					idIssuerLocationField.setWidth("100%");
					idIssuerLocationField.setClearAllowed(false);
					
					idIssuerLocationField.setParentAdjuster(new ParentAdjuster<Location>()
					{
						@Override
						public void addToParent(Location element)
						{
							if (!getContext().getSession().isLoaded(element, "issuedIdStudents")) 
								return;
					
							element.getIssuedIdStudents().add(getModel().getBean());
						}

						@Override
						public void removeFromParent(Location element)
						{
							if (!getContext().getSession().isLoaded(element, "issuedIdStudents")) 
								return;
					
							element.getIssuedIdStudents().remove(getModel().getBean());
						}
					});
					
					return idIssuerLocationField;
				}
				else if (propertyId.equals("socialSecurityId"))
				{
					socialSecurityIdField = new TextField();
					
					socialSecurityIdField.setCaption(getLocalizedString("SOCIAL_SECURITY_ID_CAPTION"));
					socialSecurityIdField.setWidth("100%");
					socialSecurityIdField.setNullRepresentation("");
					socialSecurityIdField.setNullSettingAllowed(true);
					
					if (isUserStudent())
						socialSecurityIdField.addValidator(notNullValidator);

					return socialSecurityIdField;
				}
				else if (propertyId.equals("ama"))
				{
					amaField = new TextField();
					
					amaField.setCaption(getLocalizedString("AMA_CAPTION"));
					amaField.setDescription(getLocalizedString("AMA_DESCRIPTION"));
					amaField.setWidth("100%");
					amaField.setNullRepresentation("");
					amaField.setNullSettingAllowed(true);
					
					return amaField;
				}
				else if (propertyId.equals("iban"))
				{
					ibanTextField = new TextField();
					
					ibanTextField.setCaption(getLocalizedString("IBAN_CAPTION"));
					ibanTextField.setDescription(getLocalizedString("IBAN_DESCRIPTION"));
					ibanTextField.setWidth("100%");
					ibanTextField.setNullRepresentation("");
					ibanTextField.setNullSettingAllowed(true);
					
					if (isUserStudent())
						ibanTextField.addValidator(notNullValidator);

					return  ibanTextField;
				}
				else if (propertyId.equals("immigrant"))
				{
					immigrantCheckBox = new CheckBox();
					
					immigrantCheckBox.setCaption(getLocalizedString("IS_IMMIGRANT_CAPTION"));
					immigrantCheckBox.setWidth("100%");

					return immigrantCheckBox;
				}
				else if (propertyId.equals("hasSpecialNeeds"))
				{
					hasSpecialNeedsCheckBox = new CheckBox();
					
					hasSpecialNeedsCheckBox.setCaption(getLocalizedString("HAS_SPECIAL_NEEDS_CAPTION"));
					hasSpecialNeedsCheckBox.setWidth("100%");

					return hasSpecialNeedsCheckBox;
				}
				else if (propertyId.equals("workExperience"))
				{
					workExperienceTextField = new TextField();
					
					workExperienceTextField.setCaption(getLocalizedString("WORK_EXPERIENCE_CAPTION"));
					workExperienceTextField.setWidth("100%");
					workExperienceTextField.setHeight("65px");
					workExperienceTextField.setNullRepresentation("");
					workExperienceTextField.setNullSettingAllowed(true);
					
					return workExperienceTextField;
				}
				else if (propertyId.equals("idType"))
				{
					idTypeComboBox = new EnumComboBox(IdentificationType.class);
					
					idTypeComboBox.setCaption(getLocalizedString("IDENTIFICATION_TYPE_CAPTION"));
					idTypeComboBox.setWidth("100%");
					idTypeComboBox.setNullSelectionAllowed(false);
					idTypeComboBox.setTextInputAllowed(false);

					idTypeComboBox.addValidator(notNullValidator);
					
					return idTypeComboBox;
				}
				else if (propertyId.equals("idIssueDate"))
				{
					idIssueDateField = new DateField();
					
					idIssueDateField.setCaption(getLocalizedString("ID_ISSUE_DATE_CAPTION"));
					idIssueDateField.setDescription(getLocalizedString("ID_ISSUE_DATE_DESCRIPTION"));
					idIssueDateField.setWidth("100%");
					idIssueDateField.setResolution(DateField.RESOLUTION_DAY);

					if (isUserStudent())
						idIssueDateField.addValidator(notNullValidator);

					return idIssueDateField;
				}
				else if (propertyId.equals("idIssuer"))
				{
					idIssuerTextField = new TextField();

					idIssuerTextField.setCaption(getLocalizedString("ID_ISSUER_CAPTION"));
					idIssuerTextField.setDescription(getLocalizedString("ID_ISSUER_DESCRIPTION"));
					idIssuerTextField.setWidth("100%");
					idIssuerTextField.setNullRepresentation("");
					idIssuerTextField.setNullSettingAllowed(true);
					
					if (isUserStudent())
						idIssuerTextField.addValidator(notNullValidator);

					return idIssuerTextField;
				}
				else if (propertyId.equals("religiousMinority"))
				{
					religiousMinorityCheckBox = new CheckBox();
					
					religiousMinorityCheckBox.setCaption(getLocalizedString("RELIGIOUS_MINORITY_CAPTION"));
					religiousMinorityCheckBox.setWidth("100%");
					
					return religiousMinorityCheckBox;
				}
				else if (propertyId.equals("ethnicMinority"))
				{
					ethnicMinorityCheckBox = new CheckBox();
					
					ethnicMinorityCheckBox.setCaption(getLocalizedString("ETHNIC_MINORITY_CAPTION"));
					ethnicMinorityCheckBox.setWidth("100%");
					
					return ethnicMinorityCheckBox;
				}
				else if (propertyId.equals("hasOtherDegree"))
				{
					hasOtherDegreeCheckBox = new CheckBox();
					
					hasOtherDegreeCheckBox.setCaption(getLocalizedString("OTHER_DEGREE_CAPTION"));
					hasOtherDegreeCheckBox.setWidth("100%");
					
					return hasOtherDegreeCheckBox;
				}
				else if (propertyId.equals("nationality"))
				{
					nationalityPickerField = new NationalityPickerField();
					
					nationalityPickerField.setCaption(getLocalizedString("NATIONALITY_CAPTION"));
					nationalityPickerField.setWidth("100%");
					nationalityPickerField.setClearAllowed(false);
					
					nationalityPickerField.addValidator(notNullValidator);
					
					nationalityPickerField.setParentAdjuster(new PickerField.ParentAdjuster<Nationality>()
					{
						@Override
						public void addToParent(Nationality element)
						{
							if (!getContext().getSession().isLoaded(element, "students")) 
								return;
					
							element.getStudents().add(getModel().getBean());
						}

						@Override
						public void removeFromParent(Nationality element)
						{
							if (!getContext().getSession().isLoaded(element, "students")) 
								return;
					
							element.getStudents().remove(getModel().getBean());
						}
					});

					return nationalityPickerField;
				}
				else if (propertyId.equals("publicClerk"))
				{
					publicClerkCheckBox = new CheckBox();
					
					publicClerkCheckBox.setCaption(getLocalizedString("PUBLIC_CLERK_CAPTION"));
					publicClerkCheckBox.setWidth("100%");
					
					return publicClerkCheckBox;
				}
				
				return null;
			}
		});
		
	}

	@Override
	public boolean isDataValid()
	{
		return this.form.isValid();
	}

	@Override
	protected void setupLocalizedCaptions(Locale locale)
	{
		super.setupLocalizedCaptions(locale);
		
		if (this.form != null)
		{
			this.form.setCaption(getLocalizedString("ADDITIONAL_DATA_CAPTION"));
			DataUtilities.setValidatorsLocale(this.form, this.getLocale());
		}
		
		if (serialNumberTextField != null)
		{
			serialNumberTextField.setCaption(getLocalizedString("SERIAL_NUMBER_CAPTION"));
			serialNumberTextField.setDescription(getLocalizedString("SERIAL_NUMBER_DESCRIPTION"));
		}

		if (idNumberTextField != null) 
			idNumberTextField.setCaption(getLocalizedString("ID_NUMBER_CAPTION"));

		if (taxCodeTextField != null) 
			taxCodeTextField.setCaption(getLocalizedString("TAX_CODE_CAPTION"));

		if (taxDivisionTextField != null)
			taxDivisionTextField.setCaption(getLocalizedString("TAX_DIVISION_CAPTION"));

		if (admissionDateField != null)
		{
			admissionDateField.setCaption(getLocalizedString("ADMISSION_DATE_CAPTION"));
			admissionDateField.setLocale(locale);
		}

		if (idIssuerLocationField != null) 
		{
			idIssuerLocationField.setCaption(getLocalizedString("ID_ISSUER_LOCATION_CAPTION"));
			idIssuerLocationField.setDescription(getLocalizedString("ID_ISSUER_LOCATION_DESCRIPTION"));
		}

		if (socialSecurityIdField != null) 
			socialSecurityIdField.setCaption(getLocalizedString("SOCIAL_SECURITY_ID_CAPTION"));

		if (amaField != null)
		{
			amaField.setCaption(getLocalizedString("AMA_CAPTION"));
			amaField.setDescription(getLocalizedString("AMA_DESCRIPTION"));
		}

		if (ibanTextField != null)
		{
			ibanTextField.setCaption(getLocalizedString("IBAN_CAPTION"));
			ibanTextField.setDescription(getLocalizedString("IBAN_DESCRIPTION"));
		}

		if (immigrantCheckBox != null) 
			immigrantCheckBox.setCaption(getLocalizedString("IS_IMMIGRANT_CAPTION"));

		if (hasSpecialNeedsCheckBox != null) 
			hasSpecialNeedsCheckBox.setCaption(getLocalizedString("HAS_SPECIAL_NEEDS_CAPTION"));

		if (workExperienceTextField != null) 
			workExperienceTextField.setCaption(getLocalizedString("WORK_EXPERIENCE_CAPTION"));

		if (idTypeComboBox != null) 
			idTypeComboBox.setCaption(getLocalizedString("IDENTIFICATION_TYPE_CAPTION"));

		if (idIssueDateField != null)
		{
			idIssueDateField.setCaption(getLocalizedString("ID_ISSUE_DATE_CAPTION"));
			idIssueDateField.setDescription(getLocalizedString("ID_ISSUE_DATE_DESCRIPTION"));
		}

		if (idIssuerTextField != null)
		{
			idIssuerTextField.setCaption(getLocalizedString("ID_ISSUER_CAPTION"));
			idIssuerTextField.setDescription(getLocalizedString("ID_ISSUER_DESCRIPTION"));
		}

		if (religiousMinorityCheckBox != null) 
			religiousMinorityCheckBox.setCaption(getLocalizedString("RELIGIOUS_MINORITY_CAPTION"));

		if (ethnicMinorityCheckBox != null) 
			ethnicMinorityCheckBox.setCaption(getLocalizedString("ETHNIC_MINORITY_CAPTION"));

		if (hasOtherDegreeCheckBox != null) 
			hasOtherDegreeCheckBox.setCaption(getLocalizedString("OTHER_DEGREE_CAPTION"));

		if (nationalityPickerField != null) 
			nationalityPickerField.setCaption(getLocalizedString("NATIONALITY_CAPTION"));
		
		if (publicClerkCheckBox != null) 
			publicClerkCheckBox.setCaption(getLocalizedString("PUBLIC_CLERK_CAPTION"));
	}

	@Override
	public void discardChanges()
	{
		this.form.discard();
	}

	@Override
	public void commitChangesToModel()
	{
		this.form.commit();
	}

	@AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("100%");
		mainLayout.setMargin(false);
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("100.0%");
		
		// form
		form = new AdditionalDataForm();
		form.setCaption("Πρόσθετα Στοιχεία Χρήστη");
		form.setImmediate(false);
		form.setWidth("100.0%");
		form.setHeight("-1px");
		mainLayout.addComponent(form);
		
		return mainLayout;
	}

	@Override
	public void setViewFullyWritable(Boolean isWritable) 
	{
		this.fullyWritableForm = isWritable;
	}

	@Override
	public Boolean isViewFullyWritable() 
	{
		return this.fullyWritableForm;
	}
}
