package softeng.coop.ui.composites;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Locale;
import java.util.Set;

import softeng.coop.dataaccess.Benefits;
import softeng.coop.dataaccess.CoOp;
import softeng.coop.dataaccess.Company;
import softeng.coop.dataaccess.JobPosting;
import softeng.coop.ui.ICoopContext;
import softeng.coop.ui.forms.CompanyForm;
import softeng.coop.ui.presenters.JobPostingsCardPresenter;
import softeng.coop.ui.viewdefinitions.IJobPostingsCardView;
import softeng.coop.ui.viewdefinitions.IOkCancelView;
import softeng.coop.ui.viewdefinitions.viewmodels.OkCancelViewModel;
import softeng.ui.vaadin.mvp.EventSubscription;
import softeng.ui.vaadin.mvp.IListener;
import softeng.ui.vaadin.mvp.IView;
import softeng.ui.vaadin.mvp.ModelEvent;
import softeng.ui.vaadin.mvp.Presenter;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Item;
import com.vaadin.data.util.BeanItem;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Component;
import com.vaadin.ui.Field;
import com.vaadin.ui.FormFieldFactory;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;

public class JobPostingsCardComponent
	extends CoopComponent<BeanItem<CoOp>>
	implements IJobPostingsCardView
{
	@AutoGenerated
	private VerticalLayout mainLayout;

	@AutoGenerated
	private OkCancelComponent okCancelComponent;

	@AutoGenerated
	private HorizontalLayout cascadeHorizontalLayout;

	@AutoGenerated
	private VerticalLayout jobPostingDetailsVerticalLayout;

	@AutoGenerated
	private BenefitsComponent benefitsComponent;

	@AutoGenerated
	private JobPostingComponent jobPostingDetailsComponent;

	@AutoGenerated
	private JobPostingsTableComponent jobPostingsTableComponent;

	@AutoGenerated
	private VerticalLayout companiesVerticalLayout;

	@AutoGenerated
	private CompanyForm companyForm;

	@AutoGenerated
	private JobPostingPreferencesComponent jobPostingPreferencesComponent;

	@AutoGenerated
	private CompanySelectorTableComponent companySelectorTableComponent;

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	private static final long serialVersionUID = 1L;
	
	private TextField companyEmailTextField;
	
	private TextArea commentsTextArea;
	
	private CompanyPersonPickerField contactPersonPickerField;
	
	private BranchPickerField centralBranchPickerField;
	
	private EventSubscription<ModelEvent<Company>, IListener<ModelEvent<Company>>> selectedCompanyChangedSubscription;
	
	private static List<String> companyPropertyIds = createCompanyPropertyIds();
	
	public JobPostingsCardComponent()
	{
		buildMainLayout();
		setCompositionRoot(mainLayout);
		selectedCompanyChangedSubscription = new EventSubscription<ModelEvent<Company>, IListener<ModelEvent<Company>>>();
	}
	
	private static List<String> createCompanyPropertyIds()
	{
		List<String> properties = new ArrayList<String>(10);
		
		properties.add("email");
		properties.add("comments");
		properties.add("contactPerson");
		properties.add("centralBranch");
		
		return properties;
	}

	@Override
	protected Presenter<BeanItem<CoOp>, ICoopContext, ? extends IView<BeanItem<CoOp>, ICoopContext>> 
		supplyPresenter() 
	{
		return new JobPostingsCardPresenter(this);
	}

	@Override
	public void dataBind() 
	{
		if (this.getModel() == null)
		{
			this.companySelectorTableComponent.setModel(null);
			this.companySelectorTableComponent.dataBind();
			return;
		}
		
		//get companies for the selected coop
		Set<Company> companies = this.getModel().getBean().getCompanies();
		if (companies != null)
		{
			this.companySelectorTableComponent.setModel(companies);
			this.companySelectorTableComponent.setParentModel(this.getModel().getBean());
			companySelectorTableComponent.dataBind();
		}
		else
		{
			this.companySelectorTableComponent.setModel(null);
			this.companySelectorTableComponent.setParentModel(this.getModel().getBean());
			this.companySelectorTableComponent.dataBind();
		}
		
		jobPostingPreferencesComponent.setModel(this.getModel());
		jobPostingPreferencesComponent.dataBind();
	}

	@Override
	public IOkCancelView getOkCancelView() 
	{
		return this.okCancelComponent;
	}

	@SuppressWarnings("serial")
	@Override
	protected void setupUI() 
	{
		getOkCancelView().setModel(OkCancelViewModel.Save);
		
		companySelectorTableComponent.setAddVisible(false);
		companySelectorTableComponent.setEditVisible(false);
		companySelectorTableComponent.setDeleteVisible(false);
		companySelectorTableComponent.setImmediate(true);
		
		jobPostingsTableComponent.setImmediate(true);
		jobPostingsTableComponent.setWriteThrough(true);
		jobPostingsTableComponent.setEditVisible(false);

		jobPostingDetailsComponent.setCaption(null);
		jobPostingDetailsComponent.setImmediate(true);
		
		this.companySelectorTableComponent.addSelectedChangeListener(new IListener<ModelEvent<Company>>() 
		{
			
			@Override
			public void onEvent(ModelEvent<Company> event) 
			{
				onSelectedCompanyChanged(companySelectorTableComponent.getSelectedItem());
			}
				
		});
		
		this.jobPostingsTableComponent.addSelectedChangeListener(new IListener<ModelEvent<JobPosting>>() 
		{
			
			@Override
			public void onEvent(ModelEvent<JobPosting> event) 
			{
				onSelectedJobPostingChanged(jobPostingsTableComponent.getSelectedItem());
			}
		});
		
		companyForm.setReadOnly(true);
		
		companyForm.setFormFieldFactory(new FormFieldFactory()
		{
			@Override
			public Field createField(Item item, Object propertyId, Component uiContext)
			{
				if (propertyId.equals("email"))
				{
					companyEmailTextField = new TextField();

					companyEmailTextField.setWidth("100%");
					companyEmailTextField.setCaption(getLocalizedString("EMAIL_CAPTION"));
					companyEmailTextField.setNullRepresentation("");
					
					return companyEmailTextField;
				}
				else if (propertyId.equals("comments"))
				{
					commentsTextArea = new TextArea();
					
					commentsTextArea.setWidth("100%");
					commentsTextArea.setCaption(getLocalizedString("COMMENTS_CAPTION"));
					commentsTextArea.setNullRepresentation("");
					
					return commentsTextArea;
				}
				else if (propertyId.equals("contactPerson"))
				{
					contactPersonPickerField = new CompanyPersonPickerField();
					
					contactPersonPickerField.setWidth("100%");
					contactPersonPickerField.setCaption(getLocalizedString("CONTACT_PERSON_CAPTION"));
					
					return contactPersonPickerField;
				}
				else if (propertyId.equals("centralBranch"))
				{
					centralBranchPickerField = new BranchPickerField();
					
					centralBranchPickerField.setWidth("100%");
					centralBranchPickerField.setCaption(getLocalizedString("CENTRAL_BRANCH_CAPTION"));
					
					return centralBranchPickerField;
				}

				return null;
			}
		});
		
	}

	@Override
	protected void setupLocalizedCaptions(Locale locale) 
	{
		super.setupLocalizedCaptions(locale);
		
		this.companySelectorTableComponent.setCaption(getLocalizedString("COMPANY_TABLE_CAPTION"));
		this.jobPostingsTableComponent.setCaption(getLocalizedString("JOB_POSTINGS_TABLE_CAPTION"));
		this.jobPostingDetailsComponent.setCaption(getLocalizedString("JOB_POSTING_FORM_CAPTION"));
		
		companyForm.setCaption(getLocalizedString("COMPANY_FORM_CAPTION"));

		if (companyEmailTextField != null)
			companyEmailTextField.setCaption(getLocalizedString("EMAIL_CAPTION"));
		
		if (commentsTextArea != null)
			commentsTextArea.setCaption(getLocalizedString("COMMENTS_CAPTION"));
		
		if (contactPersonPickerField != null)
			contactPersonPickerField.setCaption(getLocalizedString("CONTACT_PERSON_CAPTION"));
		
		if (centralBranchPickerField != null)
			centralBranchPickerField.setCaption(getLocalizedString("CENTRAL_BRANCH_CAPTION"));

	}

	private void onSelectedCompanyChanged(BeanItem<Company> companyItem) 
	{
		Company selectedCompany = companyItem != null ? companyItem.getBean() : null;
		
		jobPostingsTableComponent.setParentModel(selectedCompany);
		
		companyForm.setItemDataSource(companyItem, companyPropertyIds);

		selectedCompanyChangedSubscription.fire(new ModelEvent<Company>(selectedCompany));
	}

	private void onSelectedJobPostingChanged(BeanItem<JobPosting> jobPostingItem) 
	{
		if (jobPostingItem != null)
		{
			jobPostingDetailsComponent.setModel(jobPostingItem);
			benefitsComponent.setModel(new BeanItem<Benefits>(jobPostingItem.getBean().getBenefits()));
		}
		else
		{
			jobPostingDetailsComponent.setModel(null);
			benefitsComponent.setModel(null);
		}
		
		jobPostingDetailsComponent.dataBind();
		benefitsComponent.dataBind();
	}

	@Override
	public boolean isDataValid() 
	{
		return jobPostingDetailsComponent.isDataValid() && benefitsComponent.isDataValid(); 
	}

	@Override
	public void discardChanges() 
	{
		jobPostingDetailsComponent.discardChanges();
		benefitsComponent.discardChanges();
	}

	@Override
	public void commitChangesToModel() 
	{
		jobPostingDetailsComponent.commitChangesToModel();
		benefitsComponent.commitChangesToModel();
	}

	@Override
	public JobPosting getSelectedJobPosting() 
	{
		return this.jobPostingsTableComponent.getSelectedValue();
	}

	@AutoGenerated
	private VerticalLayout buildMainLayout()
	{
		// common part: create layout
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("-1px");
		mainLayout.setMargin(false);
		mainLayout.setSpacing(true);
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("-1px");
		
		// cascadeHorizontalLayout
		cascadeHorizontalLayout = buildCascadeHorizontalLayout();
		mainLayout.addComponent(cascadeHorizontalLayout);
		
		// okCancelComponent
		okCancelComponent = new OkCancelComponent();
		okCancelComponent.setImmediate(false);
		okCancelComponent.setWidth("-1px");
		okCancelComponent.setHeight("-1px");
		mainLayout.addComponent(okCancelComponent);
		mainLayout.setComponentAlignment(okCancelComponent, new Alignment(10));
		
		return mainLayout;
	}

	@AutoGenerated
	private HorizontalLayout buildCascadeHorizontalLayout()
	{
		// common part: create layout
		cascadeHorizontalLayout = new HorizontalLayout();
		cascadeHorizontalLayout.setImmediate(false);
		cascadeHorizontalLayout.setWidth("100.0%");
		cascadeHorizontalLayout.setHeight("-1px");
		cascadeHorizontalLayout.setMargin(false);
		cascadeHorizontalLayout.setSpacing(true);
		
		// companiesVerticalLayout
		companiesVerticalLayout = buildCompaniesVerticalLayout();
		cascadeHorizontalLayout.addComponent(companiesVerticalLayout);
		cascadeHorizontalLayout.setExpandRatio(companiesVerticalLayout, 0.3f);
		
		// jobPostingsTableComponent
		jobPostingsTableComponent = new JobPostingsTableComponent();
		jobPostingsTableComponent.setCaption("Θέσεις Εργασίας");
		jobPostingsTableComponent.setImmediate(false);
		jobPostingsTableComponent.setWidth("100.0%");
		jobPostingsTableComponent.setHeight("-1px");
		cascadeHorizontalLayout.addComponent(jobPostingsTableComponent);
		cascadeHorizontalLayout.setExpandRatio(jobPostingsTableComponent, 0.2f);
		cascadeHorizontalLayout.setComponentAlignment(jobPostingsTableComponent, new Alignment(20));
		
		// jobPostingDetailsVerticalLayout
		jobPostingDetailsVerticalLayout = buildJobPostingDetailsVerticalLayout();
		cascadeHorizontalLayout.addComponent(jobPostingDetailsVerticalLayout);
		cascadeHorizontalLayout.setExpandRatio(jobPostingDetailsVerticalLayout, 0.5f);
		
		return cascadeHorizontalLayout;
	}

	@AutoGenerated
	private VerticalLayout buildCompaniesVerticalLayout()
	{
		// common part: create layout
		companiesVerticalLayout = new VerticalLayout();
		companiesVerticalLayout.setImmediate(false);
		companiesVerticalLayout.setWidth("100.0%");
		companiesVerticalLayout.setHeight("-1px");
		companiesVerticalLayout.setMargin(false);
		companiesVerticalLayout.setSpacing(true);
		
		// companySelectorTableComponent
		companySelectorTableComponent = new CompanySelectorTableComponent();
		companySelectorTableComponent.setCaption("Εταιρείες");
		companySelectorTableComponent.setImmediate(false);
		companySelectorTableComponent.setWidth("100.0%");
		companySelectorTableComponent.setHeight("-1px");
		companiesVerticalLayout.addComponent(companySelectorTableComponent);
		companiesVerticalLayout.setExpandRatio(companySelectorTableComponent, 0.2f);
		
		// jobPostingPreferencesComponent
		jobPostingPreferencesComponent = new JobPostingPreferencesComponent();
		jobPostingPreferencesComponent.setCaption("Γενικές Ρυθμίσεις");
		jobPostingPreferencesComponent.setImmediate(false);
		jobPostingPreferencesComponent.setWidth("100.0%");
		jobPostingPreferencesComponent.setHeight("-1px");
		companiesVerticalLayout.addComponent(jobPostingPreferencesComponent);
		companiesVerticalLayout.setExpandRatio(jobPostingPreferencesComponent, 0.2f);
		
		// companyForm
		companyForm = new CompanyForm();
		companyForm.setCaption("Λεπτομέρειες εταιρείας");
		companyForm.setImmediate(false);
		companyForm.setWidth("100.0%");
		companyForm.setHeight("-1px");
		companiesVerticalLayout.addComponent(companyForm);
		
		return companiesVerticalLayout;
	}

	@AutoGenerated
	private VerticalLayout buildJobPostingDetailsVerticalLayout()
	{
		// common part: create layout
		jobPostingDetailsVerticalLayout = new VerticalLayout();
		jobPostingDetailsVerticalLayout.setImmediate(false);
		jobPostingDetailsVerticalLayout.setWidth("100.0%");
		jobPostingDetailsVerticalLayout.setHeight("-1px");
		jobPostingDetailsVerticalLayout.setMargin(false);
		jobPostingDetailsVerticalLayout.setSpacing(true);
		
		// jobPostingDetailsComponent
		jobPostingDetailsComponent = new JobPostingComponent();
		jobPostingDetailsComponent.setCaption("Λεπτομέρειες Θέσης Εργασίας");
		jobPostingDetailsComponent.setImmediate(false);
		jobPostingDetailsComponent.setWidth("100.0%");
		jobPostingDetailsComponent.setHeight("-1px");
		jobPostingDetailsVerticalLayout.addComponent(jobPostingDetailsComponent);
		jobPostingDetailsVerticalLayout.setComponentAlignment(jobPostingDetailsComponent, new Alignment(6));
		
		// benefitsComponent
		benefitsComponent = new BenefitsComponent();
		benefitsComponent.setImmediate(false);
		benefitsComponent.setWidth("100.0%");
		benefitsComponent.setHeight("-1px");
		jobPostingDetailsVerticalLayout.addComponent(benefitsComponent);
		
		return jobPostingDetailsVerticalLayout;
	}

	@Override
	public void addSelectedCompanyChangedListener(IListener<ModelEvent<Company>> listener)
	{
		selectedCompanyChangedSubscription.add(listener);
	}

	@Override
	public void removeSelectedCompanyChangedListener(IListener<ModelEvent<Company>> listener)
	{
		selectedCompanyChangedSubscription.remove(listener);
	}

	@Override
	public void setJobPostings(Collection<JobPosting> jobPostings)
	{
		jobPostingsTableComponent.setModel(jobPostings);
		
		jobPostingsTableComponent.dataBind();
	}

	@Override
	public Collection<JobPosting> getJobPostings()
	{
		return jobPostingsTableComponent.getModel();
	}

}
